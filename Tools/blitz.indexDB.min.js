/* Blitz.js | version : 1.0.1 | author : Jade Zhang | license : MIT */
(function(a){"use strict";var b="moz moz_ o webkit ms khtml".split(" "),c=("IndexedDB$"+b.join("IndexedDB$")+"IndexedDB").split("$"),d=null;for(var e=c.length-1;e--;)window[c[e]]&&(d=window[c[e]]);d||alert("Your browser is not consist indexDB!"),"webkitIndexedDB"in window&&(window.IDBTransaction=window.webkitIDBTransaction,window.IDBKeyRange=window.webkitIDBKeyRange,window.IDBCursor=window.webkitIDBCursor),blitz.indexDB={DB:{},option:{name:"Test",version:"3.0",description:"This is a test DB!",entity:[{objName:"t1",keyName:"id",keyIncrement:!0,indexCols:{email:!0},data:[{id:1,name:"jade",email:"zhangjin_2006@126.com"},{id:2,name:"jade",email:"zjhiphop@gmail.com"}]}],openSuccessCb:function(){a.log("openSuccessCb")},transSuccessCb:function(){a.log("transSuccessCb")},transAbortCb:function(){a.log("transAbortCb")},transTimeoutCb:function(){a.log("transTimeoutCb")},cursorSuccessCb:function(){a.log("cursorSuccessCb")},addDataSuccessCb:function(b){a.log(b),a.log("addDataSuccessCb")},putDataSuccessCb:function(){a.log("putDataSuccessCb")},deleteDataSuccessCb:function(){a.log("deleteDataSuccessCb")},getDataSuccessCb:function(b){a.log(b.target.result),a.log("getDataSuccessCb")}},_constant:{trans:{read_only:IDBTransaction.READ_ONLY,read_write:IDBTransaction.READ_WRITE,version_change:IDBTransaction.VERSION_CHANGE},cursor:{next:IDBCursor.NEXT,next_unique:IDBCursor.NEXT_NO_DUPLICATE,prev:IDBCursor.PREV,prev_unique:IDBCursor.PREV_NO_DUPLICATE}},_config:{DBReady:!1},init:function(b){a.augement(this.option,b);var c=this.option,e=d.open(this.option.name),f=this;e.onsuccess=function(){var b=c.name+c.version,d=f.DB[b]=e.result;f._config.DBReady=!0;if(d.version!==c.version){var g=d.setVersion(c.version);g.onsuccess=function(a){f._createObjectStore(d),c.openSuccessCb&&c.openSuccessCb()},g.onerror=function(b){a.log("req_version.onerror")}}else c.openSuccessCb&&c.openSuccessCb()},e.onerror=function(b){a.log("request.onerror")}},_createObjectStore:function(b){var c="";for(var d=this.option.entity.length;d--;){a.log(c),c=this.option.entity[d],b.objectStoreNames.contains(c.objName)&&b.deleteObjectStore(c.objName);var e=b.createObjectStore(c.objName,{keyPath:c.keyName,autoIncrement:c.keyIncrement});for(var d in c.indexCols)c.indexCols.hasOwnProperty(d)&&e.createIndex(d,d,{unique:c.indexCols[d]});for(var f=c.data.length;f--;)c.data.hasOwnProperty(f)&&e.add(c.data[f])}},getAll:function(a,b){var c=this._cursorFactory("normal",a,b);this._cursorHandler(c,this.option)},getAllByIndex:function(a,b,c,d){var e=this._cursorFactory("index",a,b,c,d);this._cursorHandler(e,this.option)},_cursorHandler:function(b,c){b.onsuccess=function(a){var b=a.target.result,d={};return Array.isArray(b)?d=b:b&&b.value&&(d=b.value,b["continue"]&&typeof b["continue"]=="function"&&b["continue"]()),c.cursorSuccessCb&&c.cursorSuccessCb(d),d},b.onerror=function(b){a.log(b)}},deleteAll:function(){confirm("Are you sure to delete all data now?")&&this._clear()},getCurrentDB:function(){var a=this.option,b=a.name+a.version;return this.DB[b]},trans:function(b,c,d,e,f){try{var g=this._constant.trans[c],h=this.getCurrentDB(),i=h.transaction([b],g,0);return i.oncomplete=d||this.option.transSuccessCb,i.oncomplete=e||this.option.transAbortCb,i.ontimeout=e||this.option.transTimeoutCb,i.objectStore(b)}catch(j){a.log(j)}},getCursor:function(a,b){var b=b||"read_only",c=IDBKeyRange.lowerBound(0),d=this.trans(a,b),e;return d.getAll?e=d.getAll():e=d.openCursor(c),e},getRangeCursorByIndex:function(a,b,c,d){var b=b||"read_only",e=this._constant.cursor,f=e[c]||e.next;if(d){var g=null;d.only&&(g=IDBKeyRange.only(d.begin,d.begin_include)),d.begin&&d.end?g=IDBKeyRange.bound(d.begin,d.begin_include,d.end,d.end_include):d.begin?g=IDBKeyRange.lowerBound(d.begin,d.begin_include):d.end&&(g=IDBKeyRange.upperBound(d.end,d.end_include))}var e=this.trans(a,b).openCursor(g,f);return e},_bindCb:function(b,c,d,e){b.onsuccess=c||function(c){a.log(b+" success")},b.onerror=d||function(b){a.log("Error: "+e+" operation fail")}},_requestFactory:function(a,b,c,d){var e=this.trans(b,d?"read_only":"read_write"),f=e[a](c);this._bindCb(f,this.option[a+"DataSuccessCb"],null,a)},_cursorFactory:function(a,b,c,d,e){switch(a){case"normal":return this.getCursor(b,c);case"index":return this.getRangeCursorByIndex(b,c,d,e);default:return this.getCursor(b,c)}},addData:function(a,b){this._requestFactory("add",a,b)},putData:function(a,b){this._requestFactory("put",a,b)},delData:function(a,b){this._requestFactory("delete",a,b)},getData:function(a,b){this._requestFactory("get",a,b,!0)},_clear:function(){this._requestFactory("clear",tableName)}}})(blitz.utility)